@model FitHub.Models.RandevuCreateViewModel
@{
    ViewData["Title"] = "Randevu Al";
}

<h1 class="mb-4">Randevu Al</h1>

<form asp-action="Create" method="post">
    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

    <div class="row">
        <div class="col-md-4 mb-3">
            <label class="form-label">Salon</label>
            <select asp-for="SalonId" class="form-select" asp-items="Model.Salonlar" id="salonSelect"></select>
        </div>
        <div class="col-md-4 mb-3">
            <label class="form-label">Eğitmen</label>
            <select asp-for="EgitmenId" class="form-select" asp-items="Model.Egitmenler" id="egitmenSelect"></select>
        </div>
        <div class="col-md-4 mb-3">
            <label class="form-label">Tarih</label>
            <input asp-for="Tarih" class="form-control" type="date" id="tarihInput" />
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">Hizmet</label>
            <select asp-for="HizmetId" class="form-select" asp-items="Model.Hizmetler" id="hizmetSelect"></select>
            <span asp-validation-for="HizmetId" class="text-danger"></span>
            <div class="form-text" id="hizmetInfo"></div>
        </div>
        <div class="col-md-3 mb-3">
            <label class="form-label">Kişi Sayısı</label>
            <input asp-for="KisiSayisi" class="form-control" type="number" min="1" max="50" id="kisiInput" />
            <span asp-validation-for="KisiSayisi" class="text-danger"></span>
        </div>
        <div class="col-md-3 mb-3">
            <label class="form-label">Saat (30 dk aralıklarla)</label>
            <select asp-for="BaslangicStr" class="form-select" id="saatSelect">
                @foreach (var s in Model.SaatSecenekleri)
                {
                        <option value="@s">@s</option>
                }
            </select>
            <span asp-validation-for="BaslangicStr" class="text-danger"></span>
        </div>
    </div>

    <button type="submit" class="btn btn-primary">Randevuyu Oluştur</button>
    <a asp-action="Index" class="btn btn-secondary">Geri</a>
</form>

@section Scripts {
        <partial name="_ValidationScriptsPartial" />

        <script>
            let hizmetCache = [];

            async function refreshHizmetler() {
                const salonId = document.getElementById('salonSelect').value;
                const egitmenId = document.getElementById('egitmenSelect').value;
                const hizmetSelect = document.getElementById('hizmetSelect');

                const url = `@Url.Action("GetHizmetler", "Randevular")?salonId=${salonId}&egitmenId=${egitmenId}`;
                const res = await fetch(url);

                hizmetSelect.innerHTML = '';
                hizmetCache = [];

                if (!res.ok) {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'Hizmet listesi alınamadı';
                    hizmetSelect.appendChild(opt);
                    document.getElementById('hizmetInfo').textContent = '';
                    return;
                }

                const data = await res.json();
                hizmetCache = data || [];

                if (!hizmetCache.length) {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'Bu seçim için hizmet yok';
                    hizmetSelect.appendChild(opt);
                    document.getElementById('hizmetInfo').textContent = '';
                    return;
                }

                for (const h of hizmetCache) {
                    const opt = document.createElement('option');
                    opt.value = h.id;
                    opt.textContent = `${h.ad} (${h.sureDakika} dk - ${h.ucret} ₺)`;
                    hizmetSelect.appendChild(opt);
                }

                updateHizmetInfo();
                await refreshSlots();
            }

            function updateHizmetInfo() {
                const hizmetSelect = document.getElementById('hizmetSelect');
                const selectedId = parseInt(hizmetSelect.value || '0');
                const h = hizmetCache.find(x => x.id === selectedId);
                const info = document.getElementById('hizmetInfo');

                if (!h) { info.textContent = ''; return; }
                info.textContent = `Süre: ${h.sureDakika} dk | Ücret: ${h.ucret} ₺`;
            }

            async function refreshSlots() {
                const salonId = document.getElementById('salonSelect').value;
                const egitmenId = document.getElementById('egitmenSelect').value;
                const tarih = document.getElementById('tarihInput').value;
                const hizmetId = document.getElementById('hizmetSelect').value;
                const kisi = document.getElementById('kisiInput').value;
                const saatSelect = document.getElementById('saatSelect');

                if (!salonId || !egitmenId || !tarih || !hizmetId) return;

                const url = `@Url.Action("GetSlots", "Randevular")?salonId=${salonId}&egitmenId=${egitmenId}&tarih=${tarih}&hizmetId=${hizmetId}&kisiSayisi=${kisi}`;
                const res = await fetch(url);

                saatSelect.innerHTML = '';

                if (!res.ok) {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'Saat listesi alınamadı';
                    saatSelect.appendChild(opt);
                    return;
                }

                const data = await res.json();
                if (!data || data.length === 0) {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'Uygun saat yok';
                    saatSelect.appendChild(opt);
                    return;
                }

                for (const s of data) {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.textContent = s;
                    saatSelect.appendChild(opt);
                }
            }

            document.getElementById('salonSelect').addEventListener('change', refreshHizmetler);
            document.getElementById('egitmenSelect').addEventListener('change', refreshHizmetler);
            document.getElementById('tarihInput').addEventListener('change', refreshSlots);
            document.getElementById('kisiInput').addEventListener('change', refreshSlots);
            document.getElementById('hizmetSelect').addEventListener('change', async () => {
                updateHizmetInfo();
                await refreshSlots();
            });

            // ilk yükleme
            refreshHizmetler();
        </script>
}
