@model FitHub.Models.RandevuCreateViewModel
@{
    ViewData["Title"] = "Randevu Al";
}

<h1 class="mb-4">Randevu Al</h1>

<form asp-action="Create" method="post" class="needs-validation" novalidate>
    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">Salon</label>
            <select asp-for="SalonId" class="form-select" asp-items="Model.Salonlar" id="salonSelect"></select>
            <span asp-validation-for="SalonId" class="text-danger"></span>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">Eðitmen</label>
            <select asp-for="EgitmenId" class="form-select" asp-items="Model.Egitmenler" id="egitmenSelect"></select>
            <span asp-validation-for="EgitmenId" class="text-danger"></span>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4 mb-3">
            <label class="form-label">Tarih</label>
            <input asp-for="Tarih" class="form-control" type="date" id="tarihInput" />
            <span asp-validation-for="Tarih" class="text-danger"></span>
        </div>
        <div class="col-md-4 mb-3">
            <label class="form-label">Süre (dk)</label>
            <select asp-for="Sure" class="form-select" id="sureSelect">
                <option value="30">30</option>
                <option value="60">60</option>
                <option value="90">90</option>
                <option value="120">120</option>
            </select>
            <small class="text-muted">30 dakikanýn katý olmalý.</small>
            <span asp-validation-for="Sure" class="text-danger"></span>
        </div>
        <div class="col-md-4 mb-3">
            <label class="form-label">Kiþi Sayýsý</label>
            <input asp-for="KisiSayisi" class="form-control" type="number" min="1" max="50" id="kisiInput" />
            <span asp-validation-for="KisiSayisi" class="text-danger"></span>
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label">Saat (30 dk aralýklarla)</label>
        <select asp-for="BaslangicStr" class="form-select" id="saatSelect">
            @foreach (var s in Model.SaatSecenekleri)
            {
                    <option value="@s">@s</option>
            }
        </select>
        <span asp-validation-for="BaslangicStr" class="text-danger"></span>
        <div class="form-text">Uygun saatler otomatik listelenir (salon kontenjaný + eðitmen doluluðu kontrol edilir).</div>
    </div>

    <div class="row">
        <div class="col-md-8 mb-3">
            <label class="form-label">Hizmet</label>
            <input asp-for="Hizmet" class="form-control" placeholder="Örn: Pilates" />
            <span asp-validation-for="Hizmet" class="text-danger"></span>
        </div>
        <div class="col-md-4 mb-3">
            <label class="form-label">Ücret</label>
            <input asp-for="Ucret" class="form-control" type="number" step="0.01" min="0" />
            <span asp-validation-for="Ucret" class="text-danger"></span>
        </div>
    </div>

    <button type="submit" class="btn btn-primary">Randevuyu Oluþtur</button>
    <a asp-action="Index" class="btn btn-secondary">Geri</a>
</form>

@section Scripts {
        <partial name="_ValidationScriptsPartial" />

        <script>
            async function refreshSlots() {
                const salonId = document.getElementById('salonSelect').value;
                const egitmenId = document.getElementById('egitmenSelect').value;
                const tarih = document.getElementById('tarihInput').value;
                const sure = document.getElementById('sureSelect').value;
                const kisi = document.getElementById('kisiInput').value;
                const saatSelect = document.getElementById('saatSelect');

                if (!salonId || !egitmenId || !tarih || !sure) return;

                const url = `@Url.Action("GetSlots", "Randevular")?salonId=${salonId}&egitmenId=${egitmenId}&tarih=${tarih}&sure=${sure}&kisiSayisi=${kisi}`;

                const res = await fetch(url);
                saatSelect.innerHTML = '';

                if (!res.ok) {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'Saat listesi alýnamadý';
                    saatSelect.appendChild(opt);
                    return;
                }

                const data = await res.json();

                if (!data || data.length === 0) {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'Uygun saat yok';
                    saatSelect.appendChild(opt);
                    return;
                }

                for (const s of data) {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.textContent = s;
                    saatSelect.appendChild(opt);
                }
            }

            document.getElementById('salonSelect').addEventListener('change', refreshSlots);
            document.getElementById('egitmenSelect').addEventListener('change', refreshSlots);
            document.getElementById('tarihInput').addEventListener('change', refreshSlots);
            document.getElementById('sureSelect').addEventListener('change', refreshSlots);
            document.getElementById('kisiInput').addEventListener('change', refreshSlots);

            refreshSlots();
        </script>
}
